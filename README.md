# Keiros

Keiros is a modular **red team agent framework** built in Rust, designed for use with custom Command & Control (C2) systems. It lets operators craft tailored implants using a **declarative build profile** and Rust‚Äôs **conditional compilation**, aiming to **simplify agent development** while maintaining **operational flexibility**, **portability**, and **security-by-design**.

> ‚ö†Ô∏è **Disclaimer (Legal & Ethical Use Only)**  
> Keiros is intended **solely** for authorized security testing, R&D, and education in environments where you have explicit permission. Using this tool against systems you do not own or administer may violate laws and agreements. **You are responsible** for complying with all applicable regulations and contracts.

> üîß **Migration Notice**  
> Keiros is currently undergoing a **major update**: migrating from the older *feature-based* design to a modern **module-based architecture**. Some tooling (CLI, builder logic, Docker workflows) may still reference legacy terms like `features`. The refactor will standardize on a full module system for cleaner, safer extensibility.

---

## Why Keiros?

- **Rust-first safety & performance** ‚Äî memory safety by default and low overhead.  
- **Composable, profile-driven builds** ‚Äî repeatable, auditable outputs via YAML.  
- **Module-based architecture (next-gen)** ‚Äî clear boundaries between comms, tasks, and capabilities.  
- **Cross-platform, cross-toolchain** ‚Äî Dockerized builds for Linux & Windows.  
- **Operational ergonomics** ‚Äî opinionated CLI (init, build, clean, profile selection).  
- **Security-by-design defaults** ‚Äî explicit opt-in for risky functionality.  
- **Teamserver-agnostic** ‚Äî integrate with any C2 backend without lock-in.

---

## What is an Agent?

In Keiros, an **agent** is an (authorized) adversary-simulation component that runs on a target host and communicates with your C2. Conceptually, it is a **malicious program used for legitimate testing** with core behaviors:

- **Self-registration** ‚Äî sends **ID**, **IP**, **hostname**, **status**, **protocol**.  
- **Command polling** ‚Äî periodically polls (or receives) tasks from the C2.  
- **Task execution** ‚Äî runs enabled module capabilities and reports results back.

> The exact model and cadence depend on your enabled modules and profile (e.g., HTTP vs. socket, beacon intervals, jitter).

---

## Features

- Modular architecture using Cargo features (transitioning to a full **module-based** system)  
- Linux and Windows cross-compilation support via Docker  
- Multiple communication handlers (HTTP, socket)  
- Dynamic capability registration and initialization  
- CLI tooling to speed up agent development and builds (`init`, `build`, `clean`, etc.)

---

## Project Scaffold (What `keiros init` Generates)

Below is the **typical tree** of a new agent project after running `keiros init --agent-name MyAgent` and adding one legacy feature plus a loader.

```
MyAgent/
‚îú‚îÄ Cargo.toml
‚îú‚îÄ .gitignore
‚îú‚îÄ build_profiles/
‚îÇ  ‚îú‚îÄ linux_http.yaml        # Example profile (musl, http comms)
‚îÇ  ‚îî‚îÄ windows_http.yaml      # Example profile for Windows target
‚îú‚îÄ Dockerfile                # Builder image used by `keiros build`
‚îú‚îÄ feature_map.yml           # Auto-generated map of discovered features (optional)
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ main.rs                # Entry point: wires comms + loader + run loop
‚îÇ  ‚îú‚îÄ feature_loader.rs      # Generated: calls each feature's init()/register
‚îÇ  ‚îú‚îÄ comms/
‚îÇ  ‚îÇ  ‚îú‚îÄ mod.rs              # Comms trait and shared types
‚îÇ  ‚îÇ  ‚îú‚îÄ http.rs             # HTTP beacon/poll implementation (if enabled)
‚îÇ  ‚îÇ  ‚îî‚îÄ socket.rs           # Socket-based comms (if enabled)
‚îÇ  ‚îî‚îÄ features/
‚îÇ     ‚îú‚îÄ mod.rs              # Registry of features (legacy)
‚îÇ     ‚îú‚îÄ execute.rs          # Example feature (legacy capability)
‚îÇ     ‚îî‚îÄ pivot.rs            # Example generated by `keiros feature new --name pivot`
‚îî‚îÄ README.md
```

### File/Folder Breakdown (Plain English)

- **Cargo.toml** ‚Äî Project config: package name, dependencies, build settings.  
- **build_profiles/** ‚Äî YAML files that tell `keiros build` *what* to build (target, release/strip, which features/modules).  
- **Dockerfile** / **.dockerignore** ‚Äî Reproducible Docker build setup; keeps builds consistent across machines.  
- **feature_map.yml** ‚Äî *(Optional)* Auto-generated list of found features for the loader.  
- **src/main.rs** ‚Äî Program entry point. Starts comms and runs the agent loop.  
- **src/feature_loader.rs** ‚Äî Auto-generated initializer that registers/loads your features (or future modules).  
- **src/comms/** ‚Äî How the agent talks to the C2: `http.rs`, `socket.rs`. `mod.rs` holds shared types/traits.  
- **src/features/** ‚Äî *(Legacy)* Individual capabilities. `mod.rs` lists them. Example: `execute.rs`, `pivot.rs`.  
- **README.md** ‚Äî Your project‚Äôs docs (what this file is).

> **During the module-based migration**, `features/` will evolve into `modules/` with clearer boundaries and explicit capability traits. The loader generator will target modules instead of legacy features.

---

## Generated Files by Command

### `keiros init --agent-name MyAgent`
- Creates the Cargo bin, `Dockerfile`, base `build_profiles/`, and a minimal `src/` skeleton.
- May add `.cargo/config.toml` (for cross) and `.gitignore`.

### `keiros feature new --name pivot` (legacy flow)
- Adds `src/features/pivot.rs` with a stub `init()`/`execute()` implementation.
- Appends export/registration lines into `src/features/mod.rs`.
---

## Getting Started

### Prerequisites
- Docker (daemon running)  
- Rust toolchain (`rustup` recommended)  
- Git

### Install
```bash
git clone https://github.com/your-org/keiros.git
cd keiros
cargo install --path .
# Provides the `keiros` CLI
```

---

## Usage (New-User Friendly Quickstart)

### 0) Glossary
- **Profile** ‚Äî YAML file describing the build: target triple, release/strip flags, enabled modules/features.  
- **Teamserver IP / Listener port** ‚Äî your C2 endpoint where agents register & poll.

### 1) Scaffold a minimal agent
```bash
keiros init --agent-name MyAgent
# Creates a new Cargo bin with a minimal agent skeleton and a Dockerfile for building.
```

### 2) Create/adjust a build profile
Create `build_profiles/linux_http.yaml`:
```yaml
name: linux_http
target: x86_64-unknown-linux-musl
release: true
strip: true
enabled_features:        # legacy naming; migrating to modules
  - register_agent
  - execute
  - http
```

> For Windows: `x86_64-pc-windows-gnu` (or `‚Ä¶-msvc` if supported).

### 3) Add a capability (legacy ‚Äúfeature‚Äù flow)
```bash
keiros feature new --name pivot
# Generates src/features/pivot.rs and wires it into features/mod.rs
```

### 4) Build (Dockerized)
```bash
keiros build   --profile linux_http   --teamserver-ip 127.0.0.1   --listener-port 8080
```
**Flags explained**
- `--profile` ‚Äî name or path in `build_profiles/`  
- `--teamserver-ip`, `--listener-port` ‚Äî compiled into the agent‚Äôs comms config (used by HTTP/socket backends)

### 5) Clean generated images/artifacts
```bash
keiros clean                 # remove Keiros build images & artifacts
keiros clean --dry-run       # show what would be removed
keiros clean --all           # be aggressive (remove all keiros-* images)
keiros clean --keep base,ci  # keep images prefixed with base or ci
```

---

## Command Reference

| Command | Purpose | Notes |
|---|---|---|
| `keiros init --agent-name <name> [--no-cargo]` | Scaffold a new agent | Creates Cargo bin + Dockerfile for builds. |
| `keiros feature new --name <cap>` | (Legacy) add a capability | Will be replaced by module generator. |
| `keiros feature list` | List registered features | Inspects `src/features` and `Cargo.toml`. |
| `keiros build --profile <p> --teamserver-ip <ip> --teamserver-port <port> --listener <communication protocol>` | Build an agent | Uses YAML profile; embeds comms config. |
| `keiros clean [--dry-run] [--all] [--keep <prefixes>]` | Clean Docker images/artifacts | Frees disk and resets environment. |

---

## First Build Checklist (Troubleshooting)

1. **Docker daemon running?** Start Docker and ensure your user can access it.  
2. **Targets available?** Docker builder includes common targets; local builds may require `rustup target add ‚Ä¶`.  
3. **Features vs modules?** `enabled_features` is legacy; module generator support is landing.  
4. **C2 reachable?** Verify `--teamserver-ip / --listener-port` and test against the stub.  
5. **Stripping/linkers** Ensure `strip` and appropriate linkers exist in the builder image (provided by default).

---

## Roadmap (High-Level)

- Legacy feature system (current)  
- **Module-based architecture** (in progress)  
- Unified Docker workflows aligned with the new module system  
- Test harness & example modules  
- Developer guide for custom modules & comms

---

## License

See `LICENSE` for details. Use only with **explicit authorization**.
